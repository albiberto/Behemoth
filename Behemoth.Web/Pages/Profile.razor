@page "/profile"

@using Behemoth.Contracts
@using Behemoth.Web.Handlers

@inject ISnackbar Snackbar
@inject BehemothHttpClient ProfileClient

<PageTitle>Profilo Utente</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Il Mio Profilo</MudText>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
    }
    else if (profile != null)
    {
        <MudCard>
            <MudCardContent>
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                        <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;">
                            @if (!string.IsNullOrEmpty(profile.AvatarUrl))
                            {
                                <MudImage Src="@profile.AvatarUrl" Alt="Avatar"/>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large"/>
                            }
                        </MudAvatar>

                        <MudFileUpload T="IBrowserFile" Accept="image/*" FilesChanged="OnAvatarSelected"
                                       MaximumFileCount="1">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Disabled="isUploadingAvatar">
                                    @(isUploadingAvatar ? "Caricamento..." : "Cambia Avatar")
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudStack>

                    <MudTextField @bind-Value="profile.Username"
                                  Label="Nome Utente"
                                  Variant="Variant.Outlined"
                                  Required="true"/>

                    <MudTextField @bind-Value="profile.Bio"
                                  Label="Biografia"
                                  Variant="Variant.Outlined"
                                  Lines="4"
                                  MaxLength="500"/>
                </MudStack>
            </MudCardContent>

            <MudCardActions>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveProfile"
                           Disabled="isSaving">
                    @(isSaving ? "Salvataggio..." : "Salva Modifiche")
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
    else
    {
        <MudAlert Severity="Severity.Error">Impossibile caricare il profilo.</MudAlert>
    }
</MudContainer>

@code {
    private ProfileDto? profile;
    private bool isLoading = true;
    private bool isSaving;
    private bool isUploadingAvatar;
    private const long MaxFileSize = 5 * 1024 * 1024;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            profile = await ProfileClient.GetMyProfileAsync();
            if (profile == null)
            {
                Snackbar.Add("Errore nel caricamento del profilo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnAvatarSelected(IBrowserFile file)
    {
        if (file.Size > MaxFileSize)
        {
            Snackbar.Add("Il file è troppo grande. Dimensione massima: 5MB", Severity.Warning);
            return;
        }

        if (!file.ContentType.StartsWith("image/"))
        {
            Snackbar.Add("Seleziona un'immagine valida", Severity.Warning);
            return;
        }

        isUploadingAvatar = true;
        try
        {
            var result = await ProfileClient.UploadProfileImageAsync(file, MaxFileSize);
            if (profile is not null && result is not null)
            {
                profile.AvatarUrl = result.Url;
                Snackbar.Add("Avatar caricato con successo!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Errore nel caricamento dell'avatar", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUploadingAvatar = false;
        }
    }

    private async Task SaveProfile()
    {
        if (profile is null || string.IsNullOrWhiteSpace(profile.Username))
        {
            Snackbar.Add("Il nome utente è obbligatorio", Severity.Warning);
            return;
        }

        isSaving = true;
        try
        {
            var request = new UpdateProfileRequest
            {
                Username = profile.Username,
                Bio = profile.Bio
            };
            var success = await ProfileClient.SaveProfileAsync(request);
            if (success)
            {
                Snackbar.Add("Profilo salvato con successo!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Errore nel salvataggio del profilo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

}