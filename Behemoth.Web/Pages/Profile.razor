@page "/profile"

@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IAccessTokenProvider TokenProvider

<PageTitle>Profilo Utente</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Il Mio Profilo</MudText>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (profile != null)
    {
        <MudCard>
            <MudCardContent>
                <MudStack Spacing="3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                        <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;">
                            @if (!string.IsNullOrEmpty(profile.AvatarUrl))
                            {
                                <MudImage Src="@profile.AvatarUrl" Alt="Avatar" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                            }
                        </MudAvatar>
                        
                        <MudFileUpload T="IBrowserFile" Accept="image/*" FilesChanged="OnAvatarSelected" MaximumFileCount="1">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Disabled="isUploadingAvatar">
                                    @(isUploadingAvatar ? "Caricamento..." : "Cambia Avatar")
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudStack>

                    <MudTextField @bind-Value="profile.Username" 
                                  Label="Nome Utente" 
                                  Variant="Variant.Outlined"
                                  Required="true" />
                    
                    <MudTextField @bind-Value="profile.Bio" 
                                  Label="Biografia" 
                                  Variant="Variant.Outlined"
                                  Lines="4"
                                  MaxLength="500" />
                </MudStack>
            </MudCardContent>
            
            <MudCardActions>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="SaveProfile"
                           Disabled="isSaving">
                    @(isSaving ? "Salvataggio..." : "Salva Modifiche")
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
    else
    {
        <MudAlert Severity="Severity.Error">Impossibile caricare il profilo.</MudAlert>
    }
</MudContainer>

@code {
    private ProfileDto? profile;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isUploadingAvatar = false;
    private const long MaxFileSize = 5 * 1024 * 1024; // 5MB

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        try
        {
            if (!await SetAuthTokenAsync())
            {
                Snackbar.Add("Impossibile recuperare il token di autenticazione", Severity.Error);
                return;
            }

            var response = await Http.GetAsync("api/profiles/me");
            
            if (response.IsSuccessStatusCode)
            {
                profile = await response.Content.ReadFromJsonAsync<ProfileDto>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                profile = new ProfileDto { Username = "", Bio = "" };
            }
            else
            {
                Snackbar.Add("Errore nel caricamento del profilo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnAvatarSelected(IBrowserFile file)
    {
        if (file == null) return;

        if (file.Size > MaxFileSize)
        {
            Snackbar.Add("Il file è troppo grande. Dimensione massima: 5MB", Severity.Warning);
            return;
        }

        if (!file.ContentType.StartsWith("image/"))
        {
            Snackbar.Add("Seleziona un'immagine valida", Severity.Warning);
            return;
        }

        isUploadingAvatar = true;
        try
        {
            if (!await SetAuthTokenAsync()) return;

            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(MaxFileSize));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            
            content.Add(fileContent, "file", file.Name);

            var response = await Http.PostAsync("api/profiles/image", content);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<UploadImageResponse>();
                if (profile != null && result != null)
                {
                    profile.AvatarUrl = result.Url;
                }
                Snackbar.Add("Avatar caricato con successo!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Errore nel caricamento dell'avatar", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUploadingAvatar = false;
        }
    }

    private async Task SaveProfile()
    {
        if (profile == null || string.IsNullOrWhiteSpace(profile.Username))
        {
            Snackbar.Add("Il nome utente è obbligatorio", Severity.Warning);
            return;
        }

        isSaving = true;
        try
        {
            if (!await SetAuthTokenAsync()) return;

            var request = new UpdateProfileRequest
            {
                Username = profile.Username,
                Bio = profile.Bio
            };

            var response = await Http.PostAsJsonAsync("api/profiles", request);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Profilo salvato con successo!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Errore nel salvataggio del profilo", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Errore: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task<bool> SetAuthTokenAsync()
    {
        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            return true;
        }
        return false;
    }

    public class ProfileDto
    {
        public string? Id { get; set; }
        public string Username { get; set; } = "";
        public string? Bio { get; set; }
        public string? AvatarUrl { get; set; }
    }

    public class UpdateProfileRequest
    {
        public string Username { get; set; } = "";
        public string? Bio { get; set; }
    }

    public class UploadImageResponse
    {
        public string Url { get; set; } = "";
    }
}